# Codex CLI - Automated Code Review Workflow
# 
# This workflow demonstrates running Codex in CI/CD for automated code review.
# It runs on pull requests and posts review comments.
#
# Required secrets:
#   OPENAI_API_KEY - Your OpenAI API key
#
# Optional secrets:
#   ANTHROPIC_API_KEY - For Claude models

name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'
      - '**.py'
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'

jobs:
  codex-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(java|py|ts|tsx|js|jsx)$' | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Codex Review
        if: steps.changed.outputs.files != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Create review prompt
          cat > /tmp/review-prompt.md << 'PROMPT'
          Review the following code changes for:
          1. Bugs and potential errors
          2. Security vulnerabilities
          3. Performance issues
          4. Code style and best practices
          
          Be concise. Focus on actionable feedback.
          Format as markdown with file:line references.
          PROMPT
          
          # Run review on changed files
          echo "Reviewing: ${{ steps.changed.outputs.files }}"
          
          codex exec "$(cat /tmp/review-prompt.md)
          
          Changed files:
          ${{ steps.changed.outputs.files }}" \
            --model gpt-5-codex-mini \
            --dangerously-bypass-approvals-and-sandbox \
            > /tmp/review-output.md 2>&1 || true

      - name: Post Review Comment
        if: steps.changed.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = '';
            try {
              review = fs.readFileSync('/tmp/review-output.md', 'utf8');
            } catch (e) {
              review = 'Codex review completed but no output was generated.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Codex Code Review\n\n${review}\n\n---\n*Automated review by Codex CLI*`
            });
